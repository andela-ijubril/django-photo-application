machine:
  python:
    version: 2.7.5
  environment:
    DJANGO_SETTINGS_MODULE: djangogram.settings.test
dependencies:
  pre:
    - pip install --upgrade pip
    - pip install --upgrade virtualenv
#    - npm install bower
test:
  override:
    - python codango/manage.py bower install --settings=djangogram.settings.test
    - python codango/manage.py collectstatic --noinput --djangogram=codango.settings.test
    - python codango/manage.py test codango --settings=djangogram.settings.test
deployment:
  staging:
    branch: develop
    commands:
      - git fetch origin --unshallow
      - git push -f git@heroku.com:codango-staging.git $CIRCLE_SHA1:master
      - heroku run python codango/manage.py collectstatic --noinput --settings=codango.settings --app codango-staging
      - heroku run python codango/manage.py makemigrations --settings=codango.settings --app codango-staging
      - heroku run python codango/manage.py migrate --settings=codango.settings --app codango-staging
      - heroku ps:scale web=1 --app codango-staging
      - heroku ps:scale worker=1 --app codango-staging



dependencies:
  pre:
    - curl -v -L -o cf-cli_amd64.deb 'https://cli.run.pivotal.io/stable?release=debian64&source=github'
    - sudo dpkg -i cf-cli_amd64.deb
    - cf -v

test:
  post:
    - cf api https://api.ng.bluemix.net
    - cf auth $BLUEMIX_USER $BLUEMIX_PASSWORD
    - cf target -o $BLUEMIX_USER -s dev
    - cf a

deployment:
  production:
    branch: master
    commands:
      - cf push
